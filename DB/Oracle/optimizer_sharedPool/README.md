# SQL문 분석과 공유 풀

SQL문은 인덱스를 사용해서 풀스캔을 하라와 같은 처리 방법을 기술하지 않는다.

옵티마이저(파서)가 SQL문을 분석하고 실행계획을 생성해준다.

## 서버 프로세스와 분석

### 오라클에서 분석이란

- SQL문을 분석
- 어떤 테이블이나 컬럼으로 구성되어 있는지 조사
- 어떤 방법으로 처리할 것인지 결정

<br>

### 비용 기반 옵티마이저

비용(처리 시간이나 IO횟수, 자원 사용량)이 가장 적다고 생각하는 처리 계획을 생성한다.

<br>

### 비용을 계산하기 위한 기초 수치, 통계 정보

- 테이블의 row 수
- 데이터의 양
- 컴럼의 데이터 최댓값과 최소값
- 테이블 인덱스
- ...

오라클에서는 통계수집(dbms_stats)라고 불리는 작업을 통해 얻을 수 있음

오라클 자동으로 수행

### 비욜 계산에 필요한 정보

1. SQL문의 정보
    - 어떤 테이블의 어떤 데이터인지
    - 어떤 조건(WHERE절)
    - 어떤 관계(Join)
2. 테이블이나 인덱스의 통계정보
    - 작업량을 예측하기 위한 기본 수치
    - 데이터의 양
    - 최솟값, 최댓값
    - 데이터의 분포
    - 등등
3. 파라미터 정보
    - 사용할 수 있는 자원등의 정보
    - 정렬(sort)메모리의 크기
    - 풀 스캔 시 I/O 한 번에 읽어들이는 블록의 개수
    - 등등
4. 시스템 통계 정보
    - 한 번 작업하는 데 걸리는 시간의 기준
    - CPU의 클럭
    - 지금 환경의 I/O 성능
    - 등등

## 최적 실행 계획 결정

테이블의 검색 순서나 검색 방법 등을 조합하면 막대한 수가 된다.

## 공유 풀의 동작과 구조

하드 파스는 CPU 자원을 매우 소비하기 떄문에 실행 계획을 공유해서 줄인다.

공유 풀은 실행계획을 재이용하고 분석 작업을 줄이기 위한 목적을 갖고 있다.

공유 풀에 실행 계획이 저장되어 있다면 서버프로세스는 해당 방법을 꺼내서 사용하게 된다(소프트 파스).

공유 풀도 프로세스간 공유가 필수적이기 때문에 버퍼 캐시와 마찬가지로 공유 메모리에 있다.

공유 풀은 1. 라이브러리 캐시, 2. 딕셔너리 캐시 영역으로 나뉜다.

### 공유 풀 구성

1. 라이브러리 캐시
    - 실행 계획 등의 SQL정보를 저장하는 곳
2. 딕셔너리 캐시
    - 통계 정보의 캐시 등의 SQL의 실행에 필요한 메타 정보를 보관
3. 그 외
    - 공유 서버라고 불리는 구성일 때는 여기에서 정렬 처리가 수행

<br>

### SQL 중복 검사 방법

- 오라클은 해시 알고리즘을 이용한 SQL ID를 생성함
- 바인드 변수를 사용 시 조건이 달라져도 같은 SQL로 판단함

## 현업에서 적용해볼 만한 지식

1. 실행계획이 나쁘고 SQL문의 성능이 나쁠 때
    - 통계정보가 잘 수집되고 있는지 DBA에 문의
        - 수집되고 있지 않다면 `dbms_stats` 패키지를 실행하여 최신 통계 정보 수집
        - 운영정책에 따른 수집 미진행일 수 있기 때문에 협의하에 진행
    - 최신 통계정보임에도 실행계획이 최적이 아닌 경우
        - 옵티마이저의 판단이 좋지 않다는 것을 의미함.
        - 힌트나 플랜 스태빌리티(Plan Stability)라고 불리는 기능을 사용해서 오라클에 명령
2. 하드 파스가 많으며 분석에 사용하는 CPU 양이 많을 때
    - SQL문을 바인트 변수로 변경 검토
    - 실 프로젝트에서 애플리케이션을 변경하지 못하는 경우
        - `CURSOR_SHARING` 초기화 파라미터를 설정함으로써 바인드 변수를 적용한 것과 유사한 효과 발휘
        - PSR(Patch Set Release) 오라클 제품에 대한 패치 파일 적용 검토
3. 공유 풀 크기에 대한 튜닝
    - 바인드 변수를 적용하여 소프트 파스 처리되도록 SQL을 작성했음에도 캐시 크기가 작아서 밀려나는 경우가 잦음
    - 적절히 공유풀 크기를 늘리는 것이 좋음



3. 공유 풀 크기에 대한 튜닝
    - 캐시 크기가 작아서 SQL문이 캐시에서 자주 밀려나기 때문에 하드 파싱이 자주 일어나는 경우가 있음