# 커넥션과 서버프로세스의 생성

오라클은 클라이언트와의 네트워크 통신 수단으로 대부분 TCP/IP 소켓을 사용하고 있음

송수신은 실제로 네트워크의 드라이버와 OS 라이브러리가 수행함

## 오라클에서 커넥션 처리

소켓은 주소(address)와 포트(port)번호라고 리는 번호의 조합으로 식별할 수 있음

송신 측은 주소와 기다리고 있는 포트를 정확하게 지정해야 한다.

수신 측은 연락오기 만을 기다리는 프로세스가 존재한다.

그래서 오라클에서 커넥션은 크게 아래 3 가지 단계를 거친다.

1. 오라클은 리스너를 기동시키고 유지한다.
2. 클라이언트의 프로세스에서 커넥션을 시도한다.
3. 서버프로세스를 생성한다.

<br>

### 1. 리스너 기동

- 리스너는 자신이 listen해야 하는 포트 번호 등을 listen.ora에서 확인한 뒤 listen을 시작한다.
    - `listen.ora` : 리스너의 설정 파일
- 리스너는 한 개 또는 여러 개의 데이터베이스로 안내할 수 있다.
- 일반적인 리스너의 포트번호는 1521(변경 가능)
- 리스너의 설정이 끝나면 `lsnrctl start` 명령어로 listen 시작
- 리스너가 안내할 데이터베이스는 listen.ora파일에서 설정하거나 데이터베이스에서 자동으로 등록하게 된다.

<br>

### 2. 애플리케이션에서의 커넥션

- 애플리케이션의 API를 활용하거나, SQL*Plus에서 connect 명령어를 실행하는 순간에 커넥션을 수행한다.
- 애플리케이션이 전달해야 할 커넥션에 필요한 정보, 커넥션 디스크립터(connection descriptor)
    1. 주소
    2. 포트
    3. 서비스 이름
    - 일반적으로 tnsnames.ora에 커넥션 디스크립터를 작성해두고 커넥션 디스크립터마다 식별자를 붙임
```c
// CONNECTION ALIAS
ORA10G = 
(
    // 커넥션 디스크립터
    (DESCRIPTION = 
        // 소켓을 생성함에 필요한 정보
        (ADDRESS = (PROTOCOL = TCP)(HOST = XXXX)(PORT = 1521))
        // listner에게 전달할 정보
        (CONNECT_DATA = 
            (SERVER = DEDICATED)
            (SERVICE_NAME = ora10g)
        )
    )
)
```

<br>

### 3. 서버 프로세스의 생성

- OS상에서 프로세스를 생성해야 한다
    - 일반적으로도 무거운 처리 과정
    - 공유 메모리를 사용할 수 있도록 설정이 요구됨
    - 서버 프로세스용 메모리도 확보해야 함
> 위와 같은 프로세스 생성이 무겁기 때문에 클라이언트 측에서 개발 시 서버 프로세스 생성이 요구되는 물리 커넥션 생성/삭제를 반복하는 로직은 피해야 한다.
- 서버 프로세스 생성 이후, 리스터는 소켓을 서버 프로세스에 인계
    - 인계받은 서버프로세스와 클라이언트가 직접 송수신하게 된다.

## 정지 또는 리스너의 상태 확인

클라이언트에서 접속을 종료하는 처리(close or disconnected)를 하면 서버 프로세스도 종료함.

`lsnrctl` 명령어로 리스너를 정지하거나 가동 상태를 확인하고, listen하는 호스트, 포트 번호, 데이터베이스 정보를 확인할 수 있다.

<br>

### 접속을 강제로 중지하는 명령어


대부분 오라클은 TCP 통신을 사용한다.

TCP/IP 통신에서 에러를 반환하지 않으면 오라클은 문제를 인식하지 못한다.

- 클라이언트가 비정상 종료되었음에도 서버 프로세스는 데이터베이스 락을 소유한 채 wait 상태를 유지할 가능성이 있다.
- 이로 인해 클라이언트의 모든 요청이 마비될 수 있다.

이런 경우 일반적으로 접속을 자르고 락을 해제해야한다.

`alter system kill session 'sid,serial#' immediate;`

또한, 끊어졌다는 사실을 자동으로 빠르게 검출할 수 있도록 **죽은 접속 검출(DCD, Dead Connection Detection)하기 기능**을 설정하는 것을 추천함
- `&ORACLE_HOME/network/admin/sqlnet.ora` 설정 파일에서 `SQLNET.EXPIRE_TIME`(분단위, 권장값 10)을 설정하면 된다.
    - 해당 값을 주기로 검출 패밋(probe packet)을 보내서 클라이언트의 비정상 종료 여부를 확인한다

커넥션 풀에 따라 한 개의 커넥션이 끊어지면 모든 커넥션이 다시 접속하는 경우도 있음으로, 주의해야 한다.


## 커넥션 풀을 통한 성능 개선

클라이언트가 데이터베이스의 서버 프로세스를 미리 생성하여 관리하는 기술

미리 정해진 수의 데이터베이스 커넥션(서버 프로세스)을 생성하여 풀에 보관하고 커넥션 풀에서 미리 생성된 커넥션을 가져와 사용하고 다시 반환하는 방식

커넥션 과정은 아래와 같다.

1. 커넥션 풀에 사용 가능한 커넥션 풀 검색
2. 애플리케이션이 데이터베이스 연결 요청을 받았을 때 먼저 커넥션 풀에서 사용 가능한 커넥션 검색
    1. 커넥션 품에 미리 생성된 커넥션 사용
        - 리스너와는 별도로 직접 서버프로세스 사용
    2. 리스너에 서버 프로세스 생성 요청
3. 데이터베이스와 연결
4. 통신
5. 반환
6. 커넥션 풀에서 지정한 개수의 커넥션 유지


