# 캐시와 메모리

- [캐시가 필요한 이유](#캐시가-필요한-이유)
- [캐시란?](#캐시란)
- [데이터는 블록단위로 관리한다.](#데이터는-블록-단위로-관리)
- [캐시 사용으로 인덱스 검색을 효율적으로](#캐시의-사용으로-인덱스-검색을-효율적으로)
- [프로세스는 캐시를 공유한다](#프로세스는-캐시를-공유한다)
- [공유 메모리에 필요한 설정](#공유-메모리에-필요한-설정)
- [공유 메모리는 어떤식으로 보일까?](#공유-메모리는-어떤-식으로-보이는가)
- [버퍼 캐시를 정리하는 LRU 알고리즘](#버퍼-캐시를-정리하는-lruleast-recently-used-알고리즘)
- OS, 스토리지 관점에서 캐시와 메모리


## 캐시가 필요한 이유

Disk I/O 연산이 1 회에 10 ~ 20 ms 정도 소요될 정도로 느리다.

**리소스 소모가 심한 Disk I/O 연산을 최소화**하기 위해 cache 기술을 사용!

아키텍처에 대한 깊은 이해를 바탕으로 캐시 기술을 활용해야 함

- 아키텍처에 대한 이해가 없는 경우 생각지도 못한 부분에서 데이터가 캐시에 존재하지 않아 성능이 저하되는 결과를 초래함.

## 캐시란?

조회가 빈번한 데이터를 빠르게 사용할 수 있도록 데이터를 저장해두는 메모리 영역

CPU는 메모리와 나노초 단위로 데이터를 주고 받을 수 있다.

<br>

### 오라클에서 데이터 캐시(버퍼 캐시)

**서버 프로세스가 원하는 데이터가 버퍼 캐시에 적재되어 있을 때**

1. 데이터 요청
2. 서버 프로세스에서 버퍼 캐시에 해당 데이터 있는지 확인
3. 버퍼 캐시에서 데이터 읽어와서 처리
4. 결과 반환

**서버 프로세스가 원하는 데이터가 버퍼 캐시에 없는 경우**

1. 데이터 요청
2. 서버 프로세스에서 버퍼 캐시에 해당 데이터 있는지 확인
3. 데이터를 디스크에서 조회
4. 읽은 데이털르 캐시에 보관
5. sql 처리
6. 결과 반환


## 데이터는 블록 단위로 관리

오라클은 블록(오라클 독자적인 가상 메모리 단위)이라고 하는 단위로 데이터 관리

**블럭의 사이즈**

- 2KB, 4KB, 8KB, 16KB, 32KB 중 선택 가능

- 최근, 데이터와 캐시의 크기가 커짐에 따라 8KB 채용이 많다.

- 크기가 큰 테이블의 경우 시퀀셜 액세스가 필수일 때, 16KB, 32KB를 선택할 수 있다.

- 한 블럭 안에 여러 데이터가 존재할 수 있고, 블럭 단위로 데이터가 캐시된다
    - 블럭 내에 일부 데이터만 캐싱하고 싶어도 불가능하다.

<br>

**일반적인 블록의 구성**

1. 블럭 헤더
    - 관리용 영역
2. 한 번도 사용하지 않은 영역
3. 데이터가 채워져 있는 영역
4. 사용했다가 지워진 영역
5. 블럭간 사이즈 차이로 인해 사용되지 못하는 영역

- 위처럼 사용했다가 지워진 영역이나 사용되지 못하는 영역이 발생하여 메모리 저장공간의 비효율이 발생한다.

## 캐시의 사용으로 인덱스 검색을 효율적으로

![image](https://github.com/WonilLee211/TIL/assets/109330610/f7b2f3f6-28fa-4ecb-b7a8-2982508ef716)

일반적인 B+tree 인덱스 구조

키들은 정렬 상태를 유지한다.

- 그래서 특정 위치부터 탐색을 진행하면서 조건을 만족하지 않을 경우 멈추는데 이를 범위 스캔이라 한다.

**루트 노드에서 리프 노드까지 이르기까지** 조건 컬럼 값과 비교 연산을 통해 **블록 어드레스 값을 얻어 탐색을 진행**한다.

**리프노드는 키-ROWID 또는 키-PK 형태로 저장**되어 있다.

이러한 인덱스도 블록으로 저장되어 있기에, Disk I/O를 반복할 경우 비효율적이다.

이 때, 인덱스를 메모리에 적재하여 관리한다면, 실제 데이터 조회할 시 ROWID로 바로 disk에 접근할 수 있다는 장점이 있다.

## 프로세스는 캐시를 공유한다

기본적으로 다른 프로세스의 메모리를 보는 것은 불가능하다

DBMS관점에서 불편한 특징이기 때문에 이를 보완하고자 운영체제는 특수한 기능을 제공한다.

<br>

### 공유메모리

자신의 메모리 영역에 기록했던 데이터를 다른 프로세스에서도 즉시 볼 수 있다.

실제 메모리는 한 개이다.

각각의 프로세스는 공유되지 않는 본인만의 메모리 영역, PGA(Process Global Arear)를 가지고 있다.

오라클에서는 공유 메모리 기능을 수행하는 **SGA(System Global Area)**가 존재한다.

- 여러 프로세스가 접근하기 때문에 동기화가 필수적이다.
- 락(Lock)을 통한 베타제어(exclusive control)함으로써 데이터를 보호해야 한다.
- 즉, DBMS 내부에 많은 락이 존재하며 이로 인한 성능 문제가 발생하기 쉽다.

## 공유 메모리에 필요한 설정

### `DB_CACHE_SIZE`

- `initXXXX.ora` 설정파일에서 버퍼 캐시의 크기를 결정하는 파라미터
    - `XXXX` : 데이터베이스를 식별하는 ID
- 기본 크기 : 48MB
    - 하지만 적어도 수십 MB ~ 수백 MB를 할당하는 것이 좋음

### OS 별 공유메모리 설정

- 일반적으로 매뉴얼에 따라 설정하면 된다.
- DBA는 오라클의 미디어에 동봉된 릴리스 노트나 OS용 오라클 매뉴얼에 담긴 제한사항 및 신경써야 할 부분을 확인해야 한다.

## 공유 메모리는 어떤 식으로 보이는가?

명령어를 통해 프로세스 별 메모리 할당량에는 공유 메모리 용량도 포함하여 계산한다.

따라서 모든 프로세스가 사용하고 있는 메모리 총량을 계산할 때 공유 메모리 용량을 고려하는 것에 주의해야 한다.

## 버퍼 캐시를 정리하는 LRU(Least Recently Used) 알고리즘

최근에 사용하지 않은 데이터부터 캐시 아웃하는 알고리즘

블럭 별 최근 사용 여부에 대한 정보를 관리

<br>

### 데이터 조회 캐시 관리

1. SELECT문 요청
2. 디스크에서 데이터 조회
3. LRU 리스트에 따라 캐시에 어떤 블록을 버릴지 결정
    - 버퍼 캐시 블록이 버려지기 전, 데이터 변경 여부에 따라 DBWR이 Disk에 기록
4. 해당 위치에 데이터 저장

<br>

### 데이터 수정 캐시 관리

1. update문 요청
2. 버퍼 캐시에 데이터 존재하는지 확인
3. 디스크에서 블록을 읽어 옮
4. 읽은 데이터 캐시에 보관
5. 데이터 변경
6. DBWR(DB Writer Process)가 정기적으로 변경된 블록을 찾아서 Disk I/O 처리

<br>

> 주의 : full scan 데이터는 캐시에 오래 보관하지 않는다. 이로 인해, 조회가 빈번한 데이터가 캐시에서 버려지기 때문

## OS, 스토리지 관점에서 캐시와 메모리

### 스토리지 캐시란?

데이터 접근 속도를 향상시키기 위해 메모리에서 할당하는 중간 저장소

주로 디스크와 메모리 사이에서 데이터를 보관하여 접근 속도를 높이는 기술

크게 1. 블록 레벨 캐시, 2. 파일 레벨 캐시로 구분된다.


1. 블록 래벨 캐시
    - 디스크나 네트워크 스토리지 같은 느린 저장 장치의 액세스 속도를 향상시키기 위한 목적
    - 하드웨어 RAID 컨트롤러나 운영 체제 수준에서 소프트웨어 캐시로 구현됨
        - RAID(Redundant Array of Independent Disks) : 여러 개의 하드 디스크를 묶어서 하나의 눈리적인 저장장치로 사용하는 기술
    - 블록 단위로 메모리에 캐싱하며 빈번하게 액세스되는 블록들을 빠르게 I/O 가능

2. 파일 레벨 캐시(OS 캐시)
    - 파일 레벨 캐시는 주로 네트워크 파일 시스템(NFS)와 같은 파일 기반 스토리지에서 사용됨
    - 운영체제 수준에서 구현되며 클라이언트 측에서 캐싱을 수행
    - 파일 레벨 캐시는 파일 단위로 데이터를 캐싱하여 네트워크를 통한 파일 I/O에 따른 지연을 최소화함

메모리의 용량이 제한적이기 때문에 캐시 정책을 잘 설정하고 최적의 메모리 용량을 할당하는 것이 중요하다.

스토리지 캐시에 데이터를 기록하면 OS 관점에서 I/O 작업이 끝난 것이기 때문에 편리함

스토리지 캐시에 저장된 데이터가 손실되면 안되므로 **이중화나 비휘발성 메모리 기능**이 요구된다.

<br>

### OS 버퍼 캐시(파일 캐시)와 가상 메모리 차이

OS 버퍼 캐시는 오라클의 버퍼 캐시와 비슷한 기능을 수행

- 메모리의 일부를 OS의 버퍼 캐시로 할당하여 자주 사용하는 파일을 두게 된다.

가상 메모리는 메모리 영역과 디스크 영역을 하나의 논리적으로 구성한 메모리를 의미

- 프로세스에서 당장 필요한 데이터만 메모리에 적재하고 나머지는 디스크의 스왑 영역으로 사용한다.
    1. 페이지 인 : 프로세스에서 필요한 데이터를 메모리에 적재
    2. 페이지 아웃 : 사용하지 않는 데이터는 디스크로 옮김
    - `페이지` : 물리 메모리와 디스크 사이에서 주고받는 블록

<br>

### 오라클 버퍼 캐시와 가상 메모리 관계

캐시는 클수록 좋기 때문에 물리 메모리 용량 이상으로 설정하면 좋을까?

버퍼 캐시를 가상 메모리를 이용하여 용량을 설정해도 할당된 물리 메모리 이상에서는 페이징으로 인한 성능 저하가 발생하게 된디ㅏ.

그래서 버퍼 캐시는 가용할 수 있는 물리 메모리 용량에 한하여 설정해주는 것이 좋다.



> 현장에서 튜닝할 때, DBMS 자체에 캐시뿐 만 아니라, OS 캐시와 스토리지 캐시까지 고려한다면, 
> 더 좋은 설계나 해결책을 제시할 수 있다.
